<!DOCTYPE html>
<html>
	<meta charset="utf-8" />
	<title>WebSocket Test</title>

	<script src="conversions.js"></script>
	<script src="color-convert.js"></script>
	<script src="parse-color.js"></script>
	<link rel="stylesheet" href="grapick.min.css">
	<script src="grapick.min.js"></script>

	<script language="javascript" type="text/javascript">

var url = "ws://" + window.location.host + "/ws";
var output;
var button;

var main;

var config;

var effects = [
	{
		"id": 1,
		"name": "Cycle",
		"settings": [
			{
				"name": "Duration",
				"key": "duration",
				"type": "slider",
				"config": {
					"step": 1,
					"min": 1,
					"max": 10000,
					"default": 5000
				}
			},
			{
				"name": "Palette",
				"key": "paletteName",
				"type": "palette",
				"config": {
					"default": "Rainbow"
				}
			}
		]
	},
	{
		"id": 2,
		"name": "Static",
		"settings": [
			{
				"name": "Duration",
				"key": "duration",
				"type": "slider",
				"config": {
					"step": 1,
					"min": 1,
					"max": 10000,
					"default": 5000
				}
			},
			{
				"name": "Palette",
				"key": "paletteName",
				"type": "palette",
				"config": {
					"default": "Rainbow"
				}
			}
		]
	},
];

// This is called when the page finishes loading
function init() {

    // Assign page elements to variables
    button = document.getElementById("toggleButton");
    output = document.getElementById("output");

	main = document.getElementById("main");

    // Connect to WebSocket server
    wsConnect(url);
}

// Call this to connect to the WebSocket server
function wsConnect(url) {

    // Connect to WebSocket server
    websocket = new WebSocket(url);

    // Assign callbacks
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
}

// Called when a WebSocket connection is established with the server
function onOpen(evt) {
    // Log connection state
    console.log("Connected");

    // Enable button
    button.disabled = false;
}

// Called when the WebSocket connection is closed
function onClose(evt) {
    // Log disconnection state
    console.log("Disconnected");

    // Disable button
    button.disabled = true;

    // Try to reconnect after a few seconds
    setTimeout(function() { wsConnect(url) }, 2000);
}

// Called when a message is received from the server
function onMessage(evt) {
    // Print out our received message
    // console.log("Received: " + evt.data);

    output.innerHTML += evt.data + "<br>";

	config = JSON.parse(evt.data);
	console.log(config);

	handleConfig(config);
}

// Called when a WebSocket error occurs
function onError(evt) {
    console.log("ERROR: " + evt.data);
}

// Sends a message to the server (and prints it to the console)
function doSend(message) {
    console.log("Sending: " + message);
    websocket.send(message);
}

// Called whenever the HTML button is pressed
function onPress() {
    doSend("This is a client message");
}

// called when a new config arrives and needs to be displayed
function handleConfig(config) {

	// remove all children
	main.innerHTML = '';

	var devices = config.devices;
	if (!devices) {
		return;
	}

	devices.forEach((device) => {
		var deviceContainer = document.createElement("div");
		main.appendChild(deviceContainer);

		var ipHeadline = document.createElement("h2");
		deviceContainer.appendChild(ipHeadline);
		var ipText = document.createTextNode(device.ip + " (" + device.ledCount + " leds)");
		ipHeadline.appendChild(ipText);

		var virtualDevices = device.virtualDevices;
		if (!virtualDevices) {
			return;
		}

		virtualDevices.forEach((virtualDevice) => {
			var virtualDeviceContainer = document.createElement("div");
			deviceContainer.appendChild(virtualDeviceContainer);

			var nameHeadline = document.createElement("h3");
			virtualDeviceContainer.appendChild(nameHeadline);
			var nameText = document.createTextNode(virtualDevice.name + " (" + virtualDevice.id + ")");
			nameHeadline.appendChild(nameText);


			// index
			var indexParagraph = document.createElement("p");
			virtualDeviceContainer.appendChild(indexParagraph);
			var indexText = document.createTextNode(virtualDevice.startIndex + " - " + virtualDevice.endIndex);
			indexParagraph.appendChild(indexText);

			var startIndexSlider = createSlider(1, 0, device.ledCount - 1, virtualDevice.startIndex, function() {
				var value = parseInt(this.value);
				virtualDevice.startIndex = value;
				indexText.nodeValue = virtualDevice.startIndex + " - " + virtualDevice.endIndex;
			}, function() {
				var value = parseInt(this.value);
				virtualDevice.startIndex = value;
				doSend(JSON.stringify(config));
			});
			virtualDeviceContainer.appendChild(startIndexSlider);

			var endIndexSlider = createSlider(1, 1, device.ledCount, virtualDevice.endIndex, function() {
				var value = parseInt(this.value);
				virtualDevice.endIndex = value;
				indexText.nodeValue = virtualDevice.startIndex + " - " + virtualDevice.endIndex;
			}, function() {
				var value = parseInt(this.value);
				virtualDevice.endIndex = value;
				doSend(JSON.stringify(config));
			});
			virtualDeviceContainer.appendChild(endIndexSlider);


			// posOffset
			var posOffsetParagraph = document.createElement("p");
			virtualDeviceContainer.appendChild(posOffsetParagraph);
			var posOffsetText = document.createTextNode(virtualDevice.posOffsetStart + " - " + virtualDevice.posOffsetEnd);
			posOffsetParagraph.appendChild(posOffsetText);

			var posOffsetStartSlider = createSlider(0.01, 0.0, 1.0, virtualDevice.posOffsetStart, function() {
				var value = parseFloat(this.value);
				virtualDevice.posOffsetStart = value;
				posOffsetText.nodeValue = virtualDevice.posOffsetStart + " - " + virtualDevice.posOffsetEnd;
			}, function() {
				var value = parseFloat(this.value);
				virtualDevice.posOffsetStart = value;
				doSend(JSON.stringify(config));
			});
			virtualDeviceContainer.appendChild(posOffsetStartSlider);

			var posOffsetEndSlider = createSlider(0.01, 0.0, 1.0, virtualDevice.posOffsetEnd, function() {
				var value = parseFloat(this.value);
				virtualDevice.posOffsetEnd = value;
				posOffsetText.nodeValue = virtualDevice.posOffsetStart + " - " + virtualDevice.posOffsetEnd;
			}, function() {
				var value = parseFloat(this.value);
				virtualDevice.posOffsetEnd = value;
				doSend(JSON.stringify(config));
			});
			virtualDeviceContainer.appendChild(posOffsetEndSlider);



			var effectSelection = document.createElement("select");
			virtualDeviceContainer.appendChild(effectSelection);
			effectSelection.onchange = function() {
				var value = parseInt(this.value);
				console.log("Effect changed: " + value);
				virtualDevice.effectId = value;
				doSend(JSON.stringify(config));
			}

			effects.forEach((effect) => {
				var effectOption = document.createElement("option");
				effectSelection.appendChild(effectOption);
				effectOption.value = effect.id;
				effectOption.text = effect.name;

				if (effect.id == virtualDevice.effectId) {
					effectOption.selected = true;
				}
			});


			var effectSettings = createEffectSettings(virtualDevice.effectData, virtualDevice.effectId);
			virtualDeviceContainer.appendChild(effectSettings);
		});
	});


	var palettes = config.palettes;

	if (!palettes) {
		return;
	}

	palettes.forEach((palette) => {
		var paletteContainer = document.createElement("div");
		main.appendChild(paletteContainer);

		var nameHeadline = document.createElement("h3");
		paletteContainer.appendChild(nameHeadline);
		var nameText = document.createTextNode(palette.name);
		nameHeadline.appendChild(nameText);

		var gradient = document.createElement("div");
		paletteContainer.appendChild(gradient);

		const gp = new Grapick({el: gradient, type: "repeating-linear"});
		palette.keys.forEach((key) => {
			var pos = key.pos;
			var color = key.color;

			var r = (color >> 16) & 255;
			var g = (color >> 8) & 255;
			var b = color & 255;

			gp.addHandler(Math.round(pos * 100), rgb(r, g, b), {silent: true});
		});

		var updateHandler = function() {
			palette.keys = []; // empty to realize removing handlers

			gp.getHandlers().forEach((h, i) => {
				var color = parseColor(h.getColor());

				var r = color.rgb[0];
				var g = color.rgb[1];
				var b = color.rgb[2];

				console.log("#" + i + ": " + r + " " + g + " " + b);

				var color = (r << 16) | (g << 8) | b;
				palette.keys.push({"pos":h.getPosition() / 100.0, "color":color});

				doSend(JSON.stringify(config));
			});
		}


		gp.on('change', complete => {
			if (!complete) {
				return;
			}

			console.log("Gradient changed: " + gp.getSafeValue());
			updateHandler();
		});
	});


}

function createSlider(step, min, max, value, oninput, onchange) {
	var slider = document.createElement("input");
	slider.type = 'range';
	slider.step = step;
	slider.min = min;
	slider.max = max;
	slider.value = value;
	slider.oninput = oninput;
	slider.onchange = onchange;

	return slider;
}

function createEffectSettings(data, effectId) {
	var settingsContainer = document.createElement("div");

	var effect;
	effects.forEach((item) => {
		if (item.id == effectId) {
			effect = item;
		}
	});

	effect.settings.forEach((setting) => {
		var settingContainer = document.createElement("div");
		settingsContainer.appendChild(settingContainer);

		var nameParagraph = document.createElement("p");
		settingContainer.appendChild(nameParagraph);
		var nameParagraphText = document.createTextNode(setting.name);
		nameParagraph.appendChild(nameParagraphText);

		var value = data[setting.key];

		if (!value) {
			value = effect.config.default;
		}

		var oninput = function() {
			// TODO do smth
		};

		var onchangeInt = function() {
			var value = parseInt(this.value);
			console.log("SETTING " + setting.key + " changed: " + value);
			data[setting.key] = value;
			doSend(JSON.stringify(config));
		}

		var onchangeString = function() {
			var value = this.value;
			console.log("SETTING " + setting.key + " changed: " + value);
			data[setting.key] = value;
			doSend(JSON.stringify(config));
		}

		var element;

		switch(setting.type) {
			case "slider":
				element = createSliderSetting(setting.config, value, oninput, onchangeInt);
				settingContainer.appendChild(element);
				break;
			case "palette":
				element = createPaletteSetting(value, onchangeString);
				settingContainer.appendChild(element);
				break;
			default:
				console.log("UNKNOWN SETTING TYPE");
		}
	});

	return settingsContainer;
}

function createSliderSetting(config, value, oninput, onchange) {
	return createSlider(config.step, config.min, config.max, value, oninput, onchange);
}

function createPaletteSetting(value, onchange) {
	var paletteSelection = document.createElement("select");
	paletteSelection.onchange = onchange;

	var palettes = config.palettes;

	if (!palettes) {
		return null;
	}

	palettes.forEach((palette) => {
		var paletteOption = document.createElement("option");
		paletteSelection.appendChild(paletteOption);
		paletteOption.value = palette.name;
		paletteOption.text = palette.name;

		if (palette.name == value) {
			paletteOption.selected = true;
		}
	});

	return paletteSelection;
}

function rgb(r, g, b) {
	return ["rgb(",r,",",g,",",b,")"].join("");
}

// Call the init function as soon as the page loads
window.addEventListener("load", init, false);

	</script>

	<h2>LED Control</h2>
    <button id="toggleButton" onclick="onPress()" disabled>Toggle LED</button>
	<div id="output"></div>
	<div id="main"></div>
</html>
